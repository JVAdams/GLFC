---
title: "Adult Index Estimation"
author: "Jean V. Adams"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Adult Sea Lamprey Index Estimation}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, echo=FALSE}
library(knitr) 
opts_chunk$set(echo=TRUE, warning=FALSE, message=FALSE, width=80)
```

The R package **GLFC** includes functions to estimate indices of adult sea lamprey abundance in the Great Lakes.  The [Great Lakes Fishery Commission](http://www.glfc.org) made the decision to switch to a lake-wide index of adult abundance in December 2014 (GLFC-TTF 2014).  Prior to that decision, lake-wide population estimates (PE) were generated following Mullett et al. (2003).  This vignette walks you through the process of generating Adult Index estimates.

The five main functions of the **GLFC** package are:

* `AIprep()` - to prepare the Adult Index data
* `AIcheck()` - to error check the Adult Index data
* `AIestimate()` - to estimate the Adult Index
* `AItarget()` - to calculate targets for the Adult Index
* `AIreport()` - to generate a draft Adult Index report



# Install

Install the latest version of **[R](https://www.r-project.org/)** from [CRAN](https://cran.r-project.org/bin/windows/base/).

Install the latest version of the **GLFC** package following the instructions at [Readme](https://github.com/JVAdams/GLFC/blob/master/README.md).  The easiest way to do this, if you already have the package **devtools** installed, is:

```{r install_glfc, eval=FALSE}
devtools::install_github("JVAdams/GLFC")
```

If, instead, you install the **GLFC** package by downloading the [zip file](https://github.com/JVAdams/GLFC/raw/master/GLFC.zip) and installing it from the R Menu (*Packages*, *Install package(s) from local zip files...*), then you should run the following lines of code, to ensure that all the packages on which **GLFC** depends are installed.

```{r install_packages}
wantpkgs <- c("geosphere", "lubridate", "maps", "plotrix", "plyr", "rtf",
  "XLConnect")
needpkgs <- setdiff(wantpkgs, row.names(installed.packages()))
if(length(needpkgs) > 0) install.packages(needpkgs)
```



# Prepare the data

```{r, echo=FALSE}
DIRECTORY <- "C:\\JVA\\Lamprey\\Adults\\AdultIndex\\2015"
STREAMDATANEW <- "AdultStream2015.csv"
STREAMDATAPREV <- "AdultStreamThru2014.csv"
LAKEDATAPREV <- "AdultLakeThru2014.csv"
```

Three csv files are needed to generate Adult Index estimates, one each with new stream data, previous stream data, and previous lake data.

**(1)** `STREAMDATANEW` should contain stream mark-recapture estimates of adult sea lampreys for the year of interest.  

```{r, echo=FALSE}
new <- read.csv(paste(DIRECTORY, STREAMDATANEW, sep="\\"), as.is=TRUE)
new2 <- new[7:11, c("year", "lake", "lscode", "trapcatch", "PEmr", "CVmr",
  "comments")]
new2[1, "comments"] <- "no recaps"
knitr::kable(new2, row.names=FALSE)
```

The first row of `STREAMDATANEW` should be a header row with the following column names:

* `year` - survey year
* `lake` - lake code (1=Superior, 2=Michigan, 3=Huron, 4=Erie, and 5=Ontario)
* `lscode` - lake-stream code, a combination of lake and stream codes e.g., lscode = 1.064 = lake code + (stream code)/1000
* `trapcatch` = no. of adult sea lampreys captured
* `PEmr` = stream population estimate of adult sea lampreys from mark-recapture study
* `CVmr` = coefficient of variation of PEmr
* `comments` = comments

where $$ CV_{mr} = 100\% \frac{\sqrt{Var(PE_{mr})}}{PE_{mr}} $$

**(2)** `STREAMDATAPREV` should contain stream mark-recapture estimates of adult sea lampreys for all of the years prior to the year of interest. 

```{r, echo=FALSE}
old <- read.csv(paste(DIRECTORY, STREAMDATAPREV, sep="\\"), as.is=TRUE)
old2 <- old[c(896:897, 955:957), c("year", "lake", "lscode", 
  "PEmr", "CVmr", "indexContrib")]
old2$PEmr <- round(old2$PEmr, 0)
old2$CVmr <- round(old2$CVmr, 1)
old2$indexContrib <- round(old2$indexContrib, 0)
knitr::kable(old2, row.names=FALSE)
```

The first row of `STREAMDATAPREV` should be a header row with the following column names:

* `year` - survey year
* `lake` - lake code
* `lscode` - lake-stream code, a combination of lake and stream codes 
* `PEmr` = stream population estimate of adult sea lampreys from mark-recapture study
* `CVmr` = coefficient of variation
* `indexContrib` = the stream population estimate used in the Adult Index

**(3)** `LAKEDATAPREV` should contain annual lake-wide adult sea lamprey indices for all of the years prior to the year of interest. 

```{r, echo=FALSE}
lakeprev <- read.csv(paste(DIRECTORY, LAKEDATAPREV, sep="\\"), as.is=TRUE, 
  header=TRUE)
lakeprev <- lakeprev[, c("year", "lake", "index", "jlo", "jhi", "pMeet")]
lake2 <- lakeprev[119:123, ]
lake2$index <- round(lake2$index, 0)
lake2$jlo <- round(lake2$jlo, 0)
lake2$jhi <- round(lake2$jhi, 0)
lake2$pMeet <- round(lake2$pMeet, 3)
knitr::kable(lake2, row.names=FALSE)
```

The first row of `LAKEDATAPREV` should be a header row with the following column names:

* `year` - survey year
* `lake` - lake code
* `index` - estimated lake-wide index of adult sea lamprey abundance
* `jlo` - lower jackknifed range (see *[Estimate the Adult Index](#est)*)
* `jhi` - upper jackknifed range (see *[Estimate the Adult Index](#est)*)
* `pMeet` - proportion of jackknife contributions that meet the target (see *[Quantify the likelihood of being at target](#meet)*)

For all 3 files, 

* the names of the columns must be **exactly as described here** (same spelling, same case)
* the order of the columns is not important
* additional columns may be included
* there should be no missing values in `year`, `lake`, or `lscode`

All 3 files should all be stored in a single directory, `DIRECTORY`.

Assign the name of the directory (use double backslashes, \\\\, in the file path) and the names of the three files.  For example,

```{r, eval=FALSE}
DIRECTORY <- "C:\\temp"
STREAMDATANEW <- "AdultStream2015.csv"
STREAMDATAPREV <- "AdultStreamThru2014.csv"
LAKEDATAPREV <- "AdultLakeThru2014.csv"
```

Load the **GLFC** package to have access to the Adult Index functions.

```{r}
library(GLFC)
```

Use the `AIprep()` function to read in the adult sea lamprey stream trapping data and prepare them for error checking and estimation.  Simply provide the function with the name of the directory where the files are stored and the names of the new and previous stream data.

```{r}
streamall <- AIprep(csvDir=DIRECTORY, csvNew=STREAMDATANEW, 
  csvOld=STREAMDATAPREV)
```

The `AIprep()` function brings in additional information built in to the **GLFC** package by default, including 

* `trappedStreams` a data frame with stream information,

```{r, echo=FALSE}
knitr::kable(head(trappedStreams, 5), row.names=FALSE)
```

* `lsIndex` a list of lake-stream codes identifying index streams, 

```{r, echo=FALSE}
look <- sapply(lsIndex, function(x) paste(x, collapse=", "))
look <- cbind(lake=Lakenames, index.streams=look)
knitr::kable(look, row.names=FALSE)
```

* `lsKeep` a list of lake-stream codes identifying streams which will continue to have ongoing trapping even if not part of the Adult Index.

```{r, echo=FALSE}
m <- sapply(lsKeep, function(x) paste(x, collapse=", "))
m2 <- paste(m[m!=""], collapse=", ")
look <- data.frame(lake="All", maintenance.streams=m2)
knitr::kable(look, row.names=FALSE)
```

The returned object from the `AIprep()` function is a single data frame (called `streamall` in this example) with information from all of the inputs, including new variables: 

* `index` - a logical (TRUE/FALSE) identifying the index streams
* `maintain` - a logical identifying the streams that will continue to have ongoing trapping even if not part of the Adult Index
* `indexContrib` - the stream population estimate that will be used in the Adult Index (initially set to missing for `csvNew`)
* `complete` - a logical identifying streams and years for which the Adult Index has already been estimated (initially set to FALSE for `csvNew`)

```{r, echo=FALSE}
knitr::kable(tail(streamall, 5), row.names=FALSE)
```

Use the `read.csv()` function to read in the annual lake-wide adult sea lamprey indices for all of the years prior to the year of interest.

```{r, echo=-2}
lakeprev <- read.csv(paste(DIRECTORY, LAKEDATAPREV, sep="\\"), as.is=TRUE, 
  header=TRUE)
lakeprev <- lakeprev[, c("year", "lake", "index", "jlo", "jhi", "pMeet")]
```



# Error check the data

Use the `AIcheck()` function to check the data for errors and generate a report of tables and figures.  

```{r, eval=FALSE}
AIcheck(streamDat=streamall, csvDir=DIRECTORY)
```

```{r, echo=FALSE, message=TRUE}
message(
  "New RTF document created, C:\\temp/2015 Adult Index - error checking.doc")
```

The generated report is an *rtf* (rich text format) file but it has a *\*.doc* extension so that it will be automatically opened by Microsoft Word. The report is named `YYYY Adult Index - error checking.doc`, where *YYYY* is the latest year represented in `streamDat`, and placed in the directory `csvDir`.  In this example, the path to the error checking report is `C:\temp\2015 Adult Index - error checking.doc`.

The following conditions are highlighted as potential errors in the data:

* mark-recapture estimates without trap catches or CVs
* population estimates less than trap catches
* for the most recent year
    * streams missing population estimates or CVs
    * unusually large trap catches
    * unusually small trap catches

The error checking report also includes two multi-panel (one panel per stream) time series plots:

* adult sea lamprey trap efficiency estimates (trap catch / mark-recapture PE)  
![trap efficiency estimates](figures/TE.jpg)

* adult sea lamprey mark-recapture estimates  
![mark-recapture estimates](figures/MR.jpg)



<a id="est"></a>

# Estimate the Adult Index 

Use the `AIestimate()` function to estimate the Adult Index of sea lampreys in a single Great Lake.  For example, for Lake Ontario,

```{r}
ainewOnt <- AIestimate(streamDat=streamall[streamall$lake==5, ])
```

The annual Adult Index is simply the sum of stream population estimates for each year.  Missing stream estimates are estimated by a lake-specific ANOVA model relating the log of the stream estimates to the main effects of each stream and each year, weighted by the inverse of the CV squared. 

The jackknifed range is produced by recalculating the index, leaving out one stream at a time, then scaling up the result to the same scale as the Adult Index based on all streams.

The returned object from the function (`ainewOnt` in this example) is a list with 3 components: 

* `streamPE` - a data frame of stream mark-recapture and Adult Index contributions for the incomplete rows in `streamDat`, with the same variables as `streamDat` 

```{r, echo=FALSE}
ss <- ainewOnt$streamPE
ssc <- strsplit(ss$comments, ",")
ssc2 <- sapply(ssc, "[", 1)
ss$comments <- gsub("recapture", "recap", ssc2)
ss$indexContrib <- round(ss$indexContrib)
knitr::kable(ss, row.names=FALSE)
```

* `lakeIndex` - a data frame of annual lake-wide Adult Indices with 5 columns: `lake`, `year`, `index`, and the jackknifed range `jlo` and `jhi`

```{r, echo=FALSE}
knitr::kable(ainewOnt$lakeIndex, row.names=FALSE)
```

* `lakeJackRaw` - a data frame of the raw contributions to the jackknifed range with columns for `lake`, `year`, and each of the index streams.

```{r, echo=FALSE}
knitr::kable(ainewOnt$lakeJackRaw, row.names=FALSE)
```

Use the `lapply()` function to generate estimates for all 5 Great Lakes at once.  

```{r}
ainew <- lapply(1:5, function(L) AIestimate(streamall[streamall$lake==L, ]))
```

Then use the `do.call()` function to combine the estimates from the resulting list into two data frames (stream and lake estimates).

```{r}
streamainew <- do.call(rbind, lapply(ainew, "[[", 1))
lakeainew <- do.call(rbind, lapply(ainew, "[[", 2))
```

The index estimates for the lakes, `lakeainew`, looks like this:

```{r, echo=FALSE}
knitr::kable(tail(lakeainew), row.names=FALSE)
```



# Determine the targets

Use the `AItarget()` function to calculate lake-wide targets for the Adult Index of sea lamprey populations in the Great Lakes from the mean of specified years.  The `AItarget()` function takes three arguments, but only the first one needs to be provided.

```{r}
targ <- AItarget(lakeIndex=lakeprev)
```

* `lakeIndex`	- a data frame of annual lake-wide Adult Indices with (at least these) 3 columns: `lake`, `year`, and `index`
* `years`	- A list of 5 vectors (one for each Great Lake), specifying the 5 years during which there were acceptable sea lamprey wounding rates on lake trout
* `adjust` - A vector of 5 adjustments (one for each Great Lake) to be made to the mean indices when calculating the target (this is needed if the wounding rates were not acceptable during the specified years)

Default values are provided for `years` and `adjust` based on the decisions made by the Great Lakes Fishery Commission.  Currently, these values are 

```{r, echo=FALSE}
a <- as.character(formals(AItarget)$years)[-1]
b <- eval(formals(AItarget)$adjust)
ab <- data.frame(lake=Lakenames, years=gsub(":", "-", a), adjust=b)
knitr::kable(ab, row.names=FALSE)
```

The returned object from the `AItarget()` function (called `targ` in this example) is a data frame with the calculated targets for the Adult Index and expanded PE of each Great Lake.

```{r, echo=FALSE}
look <- targ
look$targInd <- round(look$targInd)
knitr::kable(look, row.names=FALSE)
```



<a id="meet"></a>

# Quantify the likelihood of being at target

Use the contributions to the jackknifed range to indicate the proportion of times (out of the total number of index streams) that the jackknifed index met the target.  This approach was suggested by the [Sea Lamprey Control Board](http://www.glfc.org/sealamp/taskforces/index.php?taskforce=slcb) in October 2015 (GLFC-SLCB 2016).

```{r}
# create an empty list for the results
jproplist <- vector("list", 5)
# cycle through the five lakes
for(i in 1:5) {
  # get the raw contribution to the jackknifed range from lake i
  jri <- ainew[[i]][[3]]
  # get the target from lake i
  ti <- targ$targInd[targ$lake==i]
  # calculate the proportion of contributions that meet the target
  jproplist[[i]] <- jackProp(jackRaw=jri, target=ti)
}
# combine the results into a single data frame
jpropdf <- do.call(rbind, jproplist)
# merge the results with the lake index data frame
lakeainewp <- merge(lakeainew, jpropdf, all=TRUE)
```

```{r, echo=FALSE}
look <- lakeainewp[!is.na(lakeainewp$pMeet), ]
look <- look[with(look, order(year, lake)), ]
knitr::kable(tail(look), row.names=FALSE)
```



# Scale up indices to PEs

Use `index2pe`, lake-specific conversion factors built in to the **GLFC** package, to scale up indices of adult sea lamprey abundance in the Great Lakes to lake-wide population estimates.

```{r, echo=FALSE}
m <- as.matrix(index2pe)
row.names(m) <- Lakenames
colnames(m) <- "index2pe"
knitr::kable(m)
```

```{r, echo=-7}
library(plyr)
lakeall <- rbind.fill(lakeprev, lakeainewp)
lakeallpe <- merge(
  lakeall[, c("lake", "year", "index", "jlo", "jhi", "pMeet")],
  cbind(lake=1:5, i2pe=index2pe))
lakeallpe$pe <- with(lakeallpe, index*i2pe)
lakeallpe$pelo <- with(lakeallpe, jlo*i2pe)
lakeallpe$pehi <- with(lakeallpe, jhi*i2pe)
knitr::kable(tail(lakeallpe, 5), row.names=FALSE)
```



# Generate a draft report

Use the `AIreport()` function to create a draft template-style report of the Adult Index estimates of sea lamprey in the Great Lakes.

```{r, eval=FALSE}
streamaiall <- rbind(streamall[streamall$complete==TRUE, ], streamainew)
AIreport(streamPEs=streamaiall, lakeIPEs=lakeallpe, targets=targ,
  csvDir=DIRECTORY)
```

```{r, echo=FALSE, message=TRUE}
message(
  "New RTF document created, C:\\temp/2015 Adult Index - draft report.doc")
```

As with the error checking report, the document generated by `AIreport()` is an *rtf* file with a *\*.doc* extension, named `YYYY Adult Index - draft report.doc`.

The report has few paragraphs summarizing the latest estimates, along with 3 tables, 

* adult sea lamprey indices for the year of interest for each lake with errors and targets
* adult sea lamprey indices for all years and all lakes
* lake-wide adult sea lamprey abundances for all years and all lakes

and 3 figures,

* 5-panel time series plot of adult sea lamprey indices (with jackknifed ranges) and targets for each Great Lake  
![Adult Index](figures/AI.jpg)

* 5-panel bar plot of adult sea lamprey abundance estimates for index streams  
![Index PEs](figures/BP.jpg)

* map showing the index streams in the Great Lakes and the relative size of the most recent population estimates  
![Index map](figures/MP.jpg)



# References

* GLFC Sea Lamprey Control Board.  2016.  15-02 Meeting Action Item and Recommendation Summary.  in Sea Lamprey Control Board Meeting 16-01, 12-14 Apr 2016, Briefing Item 1 - Attachment 2.

* GLFC Trapping Task Force.  2014.  Transitioning to the New Adult Index in 2015.  in Sea Lamprey Control Board Meeting 14-02, 15-17 Oct 2014, Briefing Item 5 - Attachment 2.

* Mullett, K. M., Heinrich, J. W., Adams, J. V., Young, R. J., Henson, M. P., McDonald, R. B., and Fodale, M. F.  2003.  Estimating lake-wide abundance of spawning-phase sea lampreys (*Petromyzon marinus*) in the Great Lakes: extrapolating from sampled streams using regression models. Journal of Great Lakes Research, 29(Supplement 1), 240–252.
